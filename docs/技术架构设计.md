# 技术架构设计

## 4.1 整体架构图

```
┌─────────────────────────────────────────────────────────────┐
│                         前端层                               │
│  ┌──────────────────┐        ┌──────────────────┐          │
│  │  用户端(Vue3)    │        │ 管理端(Vue3+EP) │          │
│  │  - 响应式布局    │        │  - 数据看板      │          │
│  │  - TailwindCSS   │        │  - 商品管理      │          │
│  └──────────────────┘        └──────────────────┘          │
└─────────────────────────────────────────────────────────────┘
                              ↕ HTTPS
┌─────────────────────────────────────────────────────────────┐
│                       服务层(Node.js)                        │
│  ┌────────┬────────┬────────┬────────┬────────┐           │
│  │用户服务│商品服务│订单服务│内容服务│营销服务│           │
│  └────────┴────────┴────────┴────────┴────────┘           │
└─────────────────────────────────────────────────────────────┘
                              ↕
┌─────────────────────────────────────────────────────────────┐
│                         数据层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐    │
│  │ PostgreSQL   │  │    Redis     │  │  OSS存储     │    │
│  │  (主数据库)  │  │   (缓存)     │  │ (图片/视频)  │    │
│  └──────────────┘  └──────────────┘  └──────────────┘    │
└─────────────────────────────────────────────────────────────┘
```

## 4.2 技术栈选型

### 前端技术栈

| 技术             | 版本  | 用途              | 选型理由                              |
| ---------------- | ----- | ----------------- | ------------------------------------- |
| **Vue 3**        | 3.4+  | 前端框架          | Composition API、性能优秀、生态成熟   |
| **TypeScript**   | 5.0+  | 类型系统          | 类型安全、代码提示、降低 bug 率       |
| **Vite**         | 5.0+  | 构建工具          | 极速启动、HMR 快、原生 ESM            |
| **Pinia**        | 2.1+  | 状态管理          | Vue 官方推荐、轻量级、TypeScript 友好 |
| **Vue Router**   | 4.2+  | 路由管理          | 官方路由库、支持动态路由              |
| **Element Plus** | 2.5+  | UI 组件库(管理端) | 组件丰富、文档完善、企业级            |
| **TailwindCSS**  | 3.4+  | 样式框架(用户端)  | 原子化 CSS、高度可定制、响应式        |
| **Axios**        | 1.6+  | HTTP 客户端       | 拦截器、请求取消、TypeScript 支持     |
| **VueUse**       | 10.7+ | 工具函数库        | Composition API 工具集                |
| **ECharts**      | 5.4+  | 数据可视化        | 图表丰富、性能好、可定制              |

### 后端技术栈

| 技术           | 版本   | 用途       | 选型理由                        |
| -------------- | ------ | ---------- | ------------------------------- |
| **Node.js**    | 20 LTS | 运行时     | 高性能、异步 I/O、生态丰富      |
| **Express**    | 4.18+  | Web 框架   | 成熟稳定、中间件丰富、易上手    |
| **TypeScript** | 5.0+   | 类型系统   | 与前端技术栈统一                |
| **Prisma**     | 5.7+   | ORM        | 类型安全、Migration、开发体验好 |
| **PostgreSQL** | 15+    | 关系数据库 | ACID 保证、JSON 支持、扩展性强  |
| **Redis**      | 7.2+   | 缓存/会话  | 高性能、数据结构丰富            |
| **JWT**        | 9.0+   | 身份认证   | 无状态、跨域支持                |
| **Multer**     | 1.4+   | 文件上传   | 中间件、多种存储方式            |
| **joi**        | 17.11+ | 数据验证   | 强大的验证规则、易用            |
| **winston**    | 3.11+  | 日志管理   | 多传输方式、格式化              |

## 4.3 项目目录结构

### 后端项目结构

```
backend/
├── src/
│   ├── controllers/      # 控制器层
│   │   ├── user.controller.ts
│   │   ├── product.controller.ts
│   │   ├── order.controller.ts
│   │   ├── content.controller.ts
│   │   └── marketing.controller.ts
│   ├── services/         # 业务逻辑层
│   │   ├── user.service.ts
│   │   ├── product.service.ts
│   │   ├── order.service.ts
│   │   └── payment.service.ts
│   ├── repositories/     # 数据访问层
│   │   ├── user.repository.ts
│   │   └── product.repository.ts
│   ├── middlewares/      # 中间件
│   │   ├── auth.middleware.ts
│   │   ├── error.middleware.ts
│   │   ├── validate.middleware.ts
│   │   └── rateLimit.middleware.ts
│   ├── routes/          # 路由定义
│   │   ├── index.ts
│   │   ├── user.routes.ts
│   │   ├── product.routes.ts
│   │   └── order.routes.ts
│   ├── utils/           # 工具函数
│   │   ├── jwt.util.ts
│   │   ├── hash.util.ts
│   │   ├── upload.util.ts
│   │   └── logger.util.ts
│   ├── types/           # 类型定义
│   │   └── index.d.ts
│   ├── config/          # 配置文件
│   │   ├── database.config.ts
│   │   ├── redis.config.ts
│   │   └── app.config.ts
│   └── app.ts           # 应用入口
├── prisma/
│   ├── schema.prisma    # Prisma模型定义
│   └── migrations/      # 数据库迁移文件
├── tests/               # 测试文件
├── .env.example         # 环境变量示例
├── package.json
├── tsconfig.json
└── README.md
```

### 管理端项目结构

```
admin/
├── src/
│   ├── api/             # API调用
│   ├── assets/          # 静态资源
│   ├── components/      # 公共组件
│   ├── views/          # 页面组件
│   │   ├── dashboard/
│   │   ├── product/
│   │   ├── order/
│   │   ├── user/
│   │   └── marketing/
│   ├── router/         # 路由配置
│   ├── stores/         # 状态管理
│   ├── utils/          # 工具函数
│   ├── types/          # 类型定义
│   ├── App.vue
│   └── main.ts
├── public/
├── index.html
├── package.json
└── vite.config.ts
```

## 4.4 安全设计

### 认证与授权

**JWT 认证流程**:

```typescript
// 登录
POST / api / auth / login;
Request: {
  phone, password;
}
Response: {
  accessToken, // 2小时有效期
    refreshToken; // 30天有效期
}

// 刷新Token
POST / api / auth / refresh;
Request: {
  refreshToken;
}
Response: {
  accessToken;
}

// 访问受保护资源
GET / api / user / profile;
Headers: {
  Authorization: "Bearer {accessToken}";
}
```

**RBAC 权限控制**:

```typescript
// 权限中间件
const checkPermission = (permission: string) => {
  return async (req, res, next) => {
    const user = req.user;
    const hasPermission = await hasPermission(user.role, permission);
    if (!hasPermission) {
      return res.status(403).json({ error: "无权限访问" });
    }
    next();
  };
};

// 使用示例
router.delete(
  "/products/:id",
  auth,
  checkPermission("product:delete"),
  productController.delete
);
```

### 数据安全

**密码加密**:

```typescript
import bcrypt from "bcrypt";

// 注册时加密
const hashedPassword = await bcrypt.hash(password, 10);

// 登录时验证
const isValid = await bcrypt.compare(password, user.password);
```

**敏感信息脱敏**:

```typescript
// 手机号脱敏
const maskPhone = (phone: string) => {
  return phone.replace(/(\d{3})\d{4}(\d{4})/, "$1****$2");
};

// API响应脱敏
const userDTO = {
  ...user,
  phone: maskPhone(user.phone),
  password: undefined,
};
```

### 接口安全

**请求频率限制**:

```typescript
import rateLimit from "express-rate-limit";

const limiter = rateLimit({
  windowMs: 15 * 60 * 1000, // 15分钟
  max: 100, // 最多100次请求
  message: "请求过于频繁,请稍后再试",
});

app.use("/api/", limiter);
```

**防止 SQL 注入**:

- 使用 Prisma ORM 参数化查询
- 避免直接拼接 SQL 语句
- 输入验证和过滤

**XSS 防护**:

```typescript
import xss from "xss";

// 内容过滤
const sanitizedContent = xss(userInput);
```

## 4.5 性能优化

### 缓存策略

**多层缓存架构**:

```typescript
class CacheService {
  // L1: 本地内存缓存(60秒)
  private localCache = new Map();

  // L2: Redis缓存(5分钟)
  private redis = createRedisClient();

  async get(key: string) {
    // 检查本地缓存
    if (this.localCache.has(key)) {
      return this.localCache.get(key);
    }

    // 检查Redis
    const cached = await this.redis.get(key);
    if (cached) {
      this.localCache.set(key, cached);
      return JSON.parse(cached);
    }

    // 从数据库查询
    const data = await db.query(key);

    // 写入缓存
    await this.redis.setex(key, 300, JSON.stringify(data));
    this.localCache.set(key, data);

    return data;
  }
}
```

**缓存更新策略**:

- 写入时更新(Write Through)
- 失效时更新(Cache Aside)
- 定时刷新(定时任务)

### 数据库优化

**索引策略**:

```sql
-- 单列索引
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_products_category ON products(category_id);

-- 复合索引
CREATE INDEX idx_orders_user_status ON orders(user_id, status);

-- 全文索引
CREATE INDEX idx_products_search ON products
  USING gin(to_tsvector('chinese', title || ' ' || description));
```

**查询优化**:

```typescript
// 避免N+1查询
const products = await prisma.product.findMany({
  include: {
    category: true, // 预加载关联数据
    skus: true,
  },
});

// 分页查询
const products = await prisma.product.findMany({
  skip: (page - 1) * pageSize,
  take: pageSize,
});
```

### 前端优化

**代码分割**:

```typescript
// 路由懒加载
const routes = [
  {
    path: "/product",
    component: () => import("./views/ProductDetail.vue"),
  },
];

// 组件懒加载
const HeavyComponent = defineAsyncComponent(
  () => import("./components/HeavyComponent.vue")
);
```

**图片优化**:

```vue
<template>
  <!-- 懒加载 -->
  <img v-lazy="product.image" :alt="product.title" />

  <!-- 响应式图片 -->
  <img
    :srcset="`${image}-small.jpg 480w, ${image}-large.jpg 1024w`"
    sizes="(max-width: 768px) 480px, 1024px"
  />
</template>
```

## 4.6 可扩展性设计

### 微服务架构准备

**服务拆分**:

```
当前: 单体应用
  ↓
未来: 微服务
  ├── 用户服务
  ├── 商品服务
  ├── 订单服务
  ├── 内容服务
  └── 营销服务
```

**接口设计原则**:

- RESTful API 设计
- 版本控制(/api/v1/...)
- 统一响应格式
- 完善的 API 文档

### 水平扩展

**无状态设计**:

- Session 存储在 Redis
- 避免服务器本地状态
- 支持负载均衡

**数据库扩展**:

- 读写分离
- 分库分表准备
- 连接池管理

## 4.7 监控与日志

### 日志系统

```typescript
import winston from "winston";

const logger = winston.createLogger({
  level: "info",
  format: winston.format.json(),
  transports: [
    // 错误日志
    new winston.transports.File({
      filename: "error.log",
      level: "error",
    }),
    // 所有日志
    new winston.transports.File({
      filename: "combined.log",
    }),
  ],
});

// 使用示例
logger.info("User logged in", { userId: "123" });
logger.error("Payment failed", { orderId: "456", error });
```

### 错误监控

**Sentry 集成**:

```typescript
import * as Sentry from "@sentry/node";

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
});

// 捕获异常
try {
  processOrder();
} catch (error) {
  Sentry.captureException(error);
  throw error;
}
```

### 性能监控

**关键指标**:

- API 响应时间
- 数据库查询时间
- 缓存命中率
- 错误率
- 并发用户数
