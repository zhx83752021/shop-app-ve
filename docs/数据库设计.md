# æ•°æ®åº“è®¾è®¡æ–‡æ¡£

## ç›®å½•

1. [æ•°æ®åº“é€‰å‹](#1-æ•°æ®åº“é€‰å‹)
2. [ER å…³ç³»å›¾](#2-erå…³ç³»å›¾)
3. [Prisma Schema](#3-prisma-schema)
4. [ç´¢å¼•ä¼˜åŒ–](#4-ç´¢å¼•ä¼˜åŒ–)
5. [æ•°æ®è¿ç§»ç­–ç•¥](#5-æ•°æ®è¿ç§»ç­–ç•¥)

---

## 1. æ•°æ®åº“é€‰å‹

### PostgreSQL

**é€‰æ‹©ç†ç”±**:

- âœ… å®Œæ•´çš„ ACID äº‹åŠ¡æ”¯æŒ
- âœ… ä¸°å¯Œçš„æ•°æ®ç±»å‹(JSONã€æ•°ç»„ã€æšä¸¾)
- âœ… å¼ºå¤§çš„æŸ¥è¯¢èƒ½åŠ›(çª—å£å‡½æ•°ã€CTEã€å…¨æ–‡æœç´¢)
- âœ… è‰¯å¥½çš„æ‰©å±•æ€§(åˆ†åŒºè¡¨ã€å¤–é”®)
- âœ… å¼€æºå…è´¹ã€ç¤¾åŒºæ´»è·ƒ
- âœ… Vercel åŸç”Ÿæ”¯æŒ(Vercel Postgres)

**ç‰ˆæœ¬**: PostgreSQL 15+

---

## 2. ER å…³ç³»å›¾

```
ç”¨æˆ·(User) 1---N è®¢å•(Order)
ç”¨æˆ·(User) 1---N è´­ç‰©è½¦(CartItem)
ç”¨æˆ·(User) 1---N åœ°å€(Address)
ç”¨æˆ·(User) 1---N å¸–å­(Post)
ç”¨æˆ·(User) 1---N è¯„è®º(Comment)
ç”¨æˆ·(User) N---N ä¼˜æƒ åˆ¸(Coupon) [é€šè¿‡CouponUser]

å•†å“(Product) N---1 åˆ†ç±»(Category)
å•†å“(Product) 1---N SKU
å•†å“(Product) 1---N è®¢å•é¡¹(OrderItem)
å•†å“(Product) 1---N è´­ç‰©è½¦é¡¹(CartItem)
å•†å“(Product) N---N å¸–å­(Post) [é€šè¿‡PostProduct]

è®¢å•(Order) 1---N è®¢å•é¡¹(OrderItem)
è®¢å•(Order) N---1 åœ°å€(Address)
è®¢å•(Order) 1---N é€€æ¬¾(Refund)

å¸–å­(Post) 1---N è¯„è®º(Comment)
```

---

## 3. Prisma Schema

### schema.prisma å®Œæ•´å®šä¹‰

```prisma
// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ç”¨æˆ·æ¨¡å— ====================

model User {
  id            String   @id @default(cuid())
  phone         String   @unique
  password      String
  nickname      String   @default("æ–°ç”¨æˆ·")
  avatar        String?
  email         String?  @unique
  gender        Gender   @default(UNKNOWN)
  birthday      DateTime?

  // ä¼šå‘˜ä¿¡æ¯
  memberLevel   MemberLevel @default(NORMAL)
  points        Int      @default(0)
  growthValue   Int      @default(0)
  balance       Decimal  @default(0) @db.Decimal(10, 2)

  // çŠ¶æ€
  status        UserStatus @default(ACTIVE)
  isVerified    Boolean  @default(false)

  // æ—¶é—´æˆ³
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLoginAt   DateTime?

  // å…³è”
  addresses     Address[]
  orders        Order[]
  cartItems     CartItem[]
  coupons       CouponUser[]
  posts         Post[]
  comments      Comment[]
  favorites     Favorite[]
  browseHistory BrowseHistory[]

  @@index([phone])
  @@index([memberLevel])
  @@map("users")
}

enum Gender {
  MALE
  FEMALE
  UNKNOWN
}

enum UserStatus {
  ACTIVE      // æ­£å¸¸
  DISABLED    // ç¦ç”¨
  DELETED     // å·²åˆ é™¤
}

enum MemberLevel {
  NORMAL      // æ™®é€šä¼šå‘˜
  SILVER      // é“¶å¡
  GOLD        // é‡‘å¡
  PLATINUM    // é“‚é‡‘
  DIAMOND     // é’»çŸ³
}

// ==================== å•†å“æ¨¡å— ====================

model Category {
  id          String    @id @default(cuid())
  name        String
  icon        String?
  parentId    String?
  parent      Category? @relation("CategoryTree", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryTree")
  sortOrder   Int       @default(0)
  status      Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@index([parentId])
  @@map("categories")
}

model Product {
  id              String   @id @default(cuid())
  title           String
  description     String?  @db.Text
  categoryId      String
  category        Category @relation(fields: [categoryId], references: [id])
  brand           String?

  // ä»·æ ¼
  price           Decimal  @db.Decimal(10, 2)
  originalPrice   Decimal  @db.Decimal(10, 2)
  costPrice       Decimal? @db.Decimal(10, 2)

  // åº“å­˜
  stock           Int      @default(0)
  sales           Int      @default(0)

  // å›¾ç‰‡è§†é¢‘
  mainImage       String
  images          String[] @default([])
  video           String?

  // è¯¦æƒ…
  detail          String?  @db.Text
  params          Json?    // å•†å“å‚æ•°JSON

  // æ ‡ç­¾
  tags            String[] @default([])

  // çŠ¶æ€
  status          ProductStatus @default(DRAFT)
  isRecommended   Boolean  @default(false)
  isNew           Boolean  @default(false)
  isHot           Boolean  @default(false)

  // æ—¶é—´
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  publishedAt     DateTime?

  // å…³è”
  skus            SKU[]
  orderItems      OrderItem[]
  cartItems       CartItem[]
  postProducts    PostProduct[]
  favorites       Favorite[]
  browseHistory   BrowseHistory[]

  @@index([categoryId])
  @@index([status])
  @@index([createdAt])
  @@map("products")
}

enum ProductStatus {
  DRAFT       // è‰ç¨¿
  PUBLISHED   // å·²ä¸Šæ¶
  OFFLINE     // å·²ä¸‹æ¶
  DELETED     // å·²åˆ é™¤
}

model SKU {
  id          String   @id @default(cuid())
  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  // è§„æ ¼
  specs       Json     // {"color": "ç™½è‰²", "size": "M"}
  skuCode     String   @unique

  // ä»·æ ¼åº“å­˜
  price       Decimal? @db.Decimal(10, 2)
  stock       Int      @default(0)

  // å›¾ç‰‡
  image       String?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  OrderItem[]

  @@index([productId])
  @@index([skuCode])
  @@map("skus")
}

// ==================== è®¢å•æ¨¡å— ====================

model Order {
  id              String      @id @default(cuid())
  orderNo         String      @unique // è®¢å•å·

  userId          String
  user            User        @relation(fields: [userId], references: [id])

  // é‡‘é¢
  totalAmount     Decimal     @db.Decimal(10, 2)
  discountAmount  Decimal     @default(0) @db.Decimal(10, 2)
  shippingFee     Decimal     @default(0) @db.Decimal(10, 2)
  actualAmount    Decimal     @db.Decimal(10, 2) // å®ä»˜é‡‘é¢

  // åœ°å€
  addressId       String
  address         Address     @relation(fields: [addressId], references: [id])

  // æ”¶è´§ä¿¡æ¯(å¿«ç…§)
  receiverName    String
  receiverPhone   String
  receiverAddress String

  // æ”¯ä»˜
  paymentMethod   PaymentMethod @default(WECHAT)
  paymentTime     DateTime?
  transactionId   String?     // ç¬¬ä¸‰æ–¹æ”¯ä»˜æµæ°´å·

  // ç‰©æµ
  shippingMethod  String?
  shippingNo      String?     // å¿«é€’å•å·
  shippingTime    DateTime?

  // çŠ¶æ€
  status          OrderStatus @default(PENDING_PAYMENT)

  // å¤‡æ³¨
  buyerMessage    String?
  sellerMessage   String?
  cancelReason    String?

  // æ—¶é—´
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  completedAt     DateTime?

  // å…³è”
  items           OrderItem[]
  refunds         Refund[]

  @@index([userId])
  @@index([orderNo])
  @@index([status])
  @@index([createdAt])
  @@map("orders")
}

enum OrderStatus {
  PENDING_PAYMENT  // å¾…ä»˜æ¬¾
  PENDING_SHIP     // å¾…å‘è´§
  SHIPPED          // å·²å‘è´§
  COMPLETED        // å·²å®Œæˆ
  CANCELLED        // å·²å–æ¶ˆ
  REFUNDING        // é€€æ¬¾ä¸­
  REFUNDED         // å·²é€€æ¬¾
}

enum PaymentMethod {
  WECHAT   // å¾®ä¿¡æ”¯ä»˜
  ALIPAY   // æ”¯ä»˜å®
  BALANCE  // ä½™é¢æ”¯ä»˜
}

model OrderItem {
  id              String   @id @default(cuid())
  orderId         String
  order           Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)

  productId       String
  product         Product  @relation(fields: [productId], references: [id])

  skuId           String?
  sku             SKU?     @relation(fields: [skuId], references: [id])

  // å•†å“å¿«ç…§
  productTitle    String
  productImage    String
  skuSpecs        Json?    // SKUè§„æ ¼å¿«ç…§

  // ä»·æ ¼æ•°é‡
  price           Decimal  @db.Decimal(10, 2)
  quantity        Int
  totalAmount     Decimal  @db.Decimal(10, 2)

  createdAt       DateTime @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("order_items")
}

model Refund {
  id              String      @id @default(cuid())
  refundNo        String      @unique
  orderId         String
  order           Order       @relation(fields: [orderId], references: [id])

  refundAmount    Decimal     @db.Decimal(10, 2)
  refundReason    String
  refundType      RefundType
  status          RefundStatus @default(PENDING)

  rejectReason    String?
  refundTime      DateTime?

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([orderId])
  @@index([refundNo])
  @@map("refunds")
}

enum RefundType {
  REFUND_ONLY      // ä»…é€€æ¬¾
  RETURN_REFUND    // é€€è´§é€€æ¬¾
}

enum RefundStatus {
  PENDING          // å¾…å®¡æ ¸
  APPROVED         // å·²åŒæ„
  REJECTED         // å·²æ‹’ç»
  COMPLETED        // å·²å®Œæˆ
}

// ==================== è´­ç‰©è½¦æ¨¡å— ====================

model CartItem {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  quantity    Int      @default(1)
  selected    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, productId])
  @@index([userId])
  @@map("cart_items")
}

// ==================== åœ°å€æ¨¡å— ====================

model Address {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  receiverName  String
  phone       String
  province    String
  city        String
  district    String
  detail      String

  isDefault   Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orders      Order[]

  @@index([userId])
  @@map("addresses")
}

// ==================== è¥é”€æ¨¡å— ====================

model Coupon {
  id              String      @id @default(cuid())
  name            String
  type            CouponType

  // ä¼˜æƒ é‡‘é¢/æŠ˜æ‰£
  discountAmount  Decimal?    @db.Decimal(10, 2) // æ»¡å‡é‡‘é¢
  discountRate    Decimal?    @db.Decimal(3, 2)  // æŠ˜æ‰£ç‡(0.88è¡¨ç¤º8.8æŠ˜)

  // ä½¿ç”¨æ¡ä»¶
  minAmount       Decimal     @db.Decimal(10, 2) // æœ€ä½æ¶ˆè´¹é‡‘é¢
  maxDiscount     Decimal?    @db.Decimal(10, 2) // æœ€é«˜ä¼˜æƒ é‡‘é¢

  // é€‚ç”¨èŒƒå›´
  scope           CouponScope @default(ALL)
  scopeIds        String[]    @default([]) // å“ç±»IDæˆ–å•†å“ID

  // å‘æ”¾
  totalCount      Int
  receivedCount   Int         @default(0)

  // æœ‰æ•ˆæœŸ
  startTime       DateTime
  endTime         DateTime

  status          Boolean     @default(true)

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  couponUsers     CouponUser[]

  @@index([type])
  @@index([status])
  @@map("coupons")
}

enum CouponType {
  DISCOUNT    // æ»¡å‡
  RATE        // æŠ˜æ‰£
}

enum CouponScope {
  ALL         // å…¨åœº
  CATEGORY    // å“ç±»
  PRODUCT     // å•†å“
}

model CouponUser {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  couponId    String
  coupon      Coupon      @relation(fields: [couponId], references: [id])

  status      CouponUserStatus @default(UNUSED)
  usedAt      DateTime?

  receivedAt  DateTime    @default(now())

  @@unique([userId, couponId])
  @@index([userId])
  @@index([couponId])
  @@map("coupon_users")
}

enum CouponUserStatus {
  UNUSED      // æœªä½¿ç”¨
  USED        // å·²ä½¿ç”¨
  EXPIRED     // å·²è¿‡æœŸ
}

// ==================== å†…å®¹æ¨¡å— ====================

model Post {
  id          String      @id @default(cuid())
  userId      String
  user        User        @relation(fields: [userId], references: [id])

  type        PostType
  title       String
  content     String      @db.Text

  // åª’ä½“
  images      String[]    @default([])
  video       String?
  videoCover  String?
  duration    Int?        // è§†é¢‘æ—¶é•¿(ç§’)

  // ç»Ÿè®¡
  viewCount   Int         @default(0)
  likeCount   Int         @default(0)
  commentCount Int        @default(0)
  shareCount  Int         @default(0)

  // çŠ¶æ€
  status      PostStatus  @default(PENDING)

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  publishedAt DateTime?

  comments    Comment[]
  postProducts PostProduct[]

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@map("posts")
}

enum PostType {
  IMAGE
  VIDEO
}

enum PostStatus {
  PENDING    // å¾…å®¡æ ¸
  APPROVED   // å·²é€šè¿‡
  REJECTED   // å·²æ‹’ç»
  DELETED    // å·²åˆ é™¤
}

model PostProduct {
  id          String   @id @default(cuid())
  postId      String
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  commission  Decimal? @db.Decimal(5, 2) // ä½£é‡‘æ¯”ä¾‹

  createdAt   DateTime @default(now())

  @@unique([postId, productId])
  @@index([postId])
  @@index([productId])
  @@map("post_products")
}

model Comment {
  id          String   @id @default(cuid())
  postId      String
  post        Post     @relation(fields: [postId], references: [id], onDelete: Cascade)

  userId      String
  user        User     @relation(fields: [userId], references: [id])

  content     String   @db.Text
  likeCount   Int      @default(0)

  createdAt   DateTime @default(now())

  @@index([postId])
  @@index([userId])
  @@map("comments")
}

// ==================== ç”¨æˆ·è¡Œä¸ºæ¨¡å— ====================

model Favorite {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@unique([userId, productId])
  @@index([userId])
  @@map("favorites")
}

model BrowseHistory {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  productId   String
  product     Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  @@index([userId, createdAt])
  @@map("browse_history")
}

// ==================== é…ç½®æ¨¡å— ====================

model Banner {
  id          String      @id @default(cuid())
  title       String
  image       String
  link        String?
  position    BannerPosition
  sortOrder   Int         @default(0)
  status      Boolean     @default(true)

  startTime   DateTime?
  endTime     DateTime?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@index([position, sortOrder])
  @@map("banners")
}

enum BannerPosition {
  HOME        // é¦–é¡µ
  DISCOVER    // å‘ç°é¡µ
  PROFILE     // ä¸ªäººä¸­å¿ƒ
}

model Admin {
  id          String      @id @default(cuid())
  username    String      @unique
  password    String
  name        String
  email       String?     @unique
  avatar      String?
  role        AdminRole   @default(OPERATOR)
  status      Boolean     @default(true)

  lastLoginAt DateTime?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@map("admins")
}

enum AdminRole {
  SUPER       // è¶…çº§ç®¡ç†å‘˜
  OPERATOR    // è¿è¥ç®¡ç†å‘˜
  PRODUCT     // å•†å“ç®¡ç†å‘˜
  SERVICE     // å®¢æœ
  ANALYST     // æ•°æ®åˆ†æå¸ˆ
}
```

---

## 4. ç´¢å¼•ä¼˜åŒ–

### é«˜é¢‘æŸ¥è¯¢ç´¢å¼•

```sql
-- ç”¨æˆ·è¡¨
CREATE INDEX idx_users_phone ON users(phone);
CREATE INDEX idx_users_member_level ON users(member_level);
CREATE INDEX idx_users_created_at ON users(created_at);

-- å•†å“è¡¨
CREATE INDEX idx_products_category ON products(category_id);
CREATE INDEX idx_products_status ON products(status);
CREATE INDEX idx_products_created_at ON products(created_at DESC);

-- è®¢å•è¡¨
CREATE INDEX idx_orders_user ON orders(user_id);
CREATE INDEX idx_orders_no ON orders(order_no);
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_created_at ON orders(created_at DESC);

-- å¸–å­è¡¨
CREATE INDEX idx_posts_user ON posts(user_id);
CREATE INDEX idx_posts_status ON posts(status);
CREATE INDEX idx_posts_created_at ON posts(created_at DESC);
```

### å¤åˆç´¢å¼•

```sql
-- ç”¨æˆ·æµè§ˆå†å²(ç”¨æˆ·ID + æ—¶é—´å€’åº)
CREATE INDEX idx_browse_history_user_time
  ON browse_history(user_id, created_at DESC);

-- è®¢å•çŠ¶æ€+åˆ›å»ºæ—¶é—´
CREATE INDEX idx_orders_status_time
  ON orders(status, created_at DESC);

-- å•†å“çŠ¶æ€+æ¨è+åˆ›å»ºæ—¶é—´
CREATE INDEX idx_products_status_recommended
  ON products(status, is_recommended, created_at DESC);
```

### å…¨æ–‡æœç´¢ç´¢å¼•

```sql
-- å•†å“æ ‡é¢˜å’Œæè¿°å…¨æ–‡æœç´¢
CREATE INDEX idx_products_fulltext
  ON products USING gin(to_tsvector('chinese', title || ' ' || COALESCE(description, '')));

-- ä½¿ç”¨ç¤ºä¾‹
SELECT * FROM products
WHERE to_tsvector('chinese', title || ' ' || COALESCE(description, ''))
      @@ to_tsquery('chinese', 'æ—¶å°š & è¿åŠ¨é‹');
```

---

## 5. æ•°æ®è¿ç§»ç­–ç•¥

### Prisma Migration å·¥ä½œæµ

**åˆå§‹åŒ–æ•°æ®åº“**:

```bash
# 1. åˆ›å»ºè¿ç§»æ–‡ä»¶
npx prisma migrate dev --name init

# 2. ç”ŸæˆPrisma Client
npx prisma generate

# 3. æŸ¥çœ‹æ•°æ®åº“çŠ¶æ€
npx prisma migrate status
```

**æ·»åŠ æ–°å­—æ®µ**:

```bash
# 1. ä¿®æ”¹schema.prisma
# 2. åˆ›å»ºè¿ç§»
npx prisma migrate dev --name add_user_avatar

# 3. åº”ç”¨åˆ°ç”Ÿäº§ç¯å¢ƒ
npx prisma migrate deploy
```

### æ•°æ®å¡«å……(Seeding)

```typescript
// prisma/seed.ts
import { PrismaClient } from "@prisma/client";

const prisma = new PrismaClient();

async function main() {
  // åˆ›å»ºåˆ†ç±»
  await prisma.category.createMany({
    data: [
      { name: "æ—¶å°šæœé¥°", icon: "ğŸ‘—" },
      { name: "æ•°ç ç”µå­", icon: "ğŸ“±" },
      { name: "ç¾å¦†æŠ¤è‚¤", icon: "ğŸ’„" },
      { name: "é£Ÿå“ç”Ÿé²œ", icon: "ğŸ" },
      { name: "å®¶å±…ç”Ÿæ´»", icon: "ğŸ " },
    ],
  });

  // åˆ›å»ºç®¡ç†å‘˜
  await prisma.admin.create({
    data: {
      username: "admin",
      password: await bcrypt.hash("admin123", 10),
      name: "è¶…çº§ç®¡ç†å‘˜",
      role: "SUPER",
    },
  });
}

main()
  .catch(console.error)
  .finally(() => prisma.$disconnect());
```

**è¿è¡Œç§å­æ•°æ®**:

```bash
npx prisma db seed
```

### å¤‡ä»½ä¸æ¢å¤

**å¤‡ä»½æ•°æ®åº“**:

```bash
pg_dump -U username -d dbname > backup.sql
```

**æ¢å¤æ•°æ®åº“**:

```bash
psql -U username -d dbname < backup.sql
```

---

## 6. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### æŸ¥è¯¢ä¼˜åŒ–

**ä½¿ç”¨ Prisma æŸ¥è¯¢ä¼˜åŒ–**:

```typescript
// âŒ N+1æŸ¥è¯¢é—®é¢˜
const users = await prisma.user.findMany();
for (const user of users) {
  const orders = await prisma.order.findMany({
    where: { userId: user.id },
  });
}

// âœ… ä½¿ç”¨includeé¢„åŠ è½½
const users = await prisma.user.findMany({
  include: {
    orders: true,
  },
});

// âœ… åªæŸ¥è¯¢éœ€è¦çš„å­—æ®µ
const products = await prisma.product.findMany({
  select: {
    id: true,
    title: true,
    price: true,
    mainImage: true,
  },
});
```

### è¿æ¥æ± é…ç½®

```typescript
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")

  // è¿æ¥æ± é…ç½®
  // DATABASE_URL="postgresql://user:pass@localhost:5432/db?connection_limit=10&pool_timeout=20"
}
```

### æ‰¹é‡æ“ä½œ

```typescript
// âŒ å¾ªç¯æ’å…¥
for (const item of items) {
  await prisma.product.create({ data: item });
}

// âœ… æ‰¹é‡æ’å…¥
await prisma.product.createMany({
  data: items,
});
```

---

## 7. æ•°æ®å®‰å…¨

### æ•æ„Ÿæ•°æ®åŠ å¯†

```typescript
// å¯†ç åŠ å¯†å­˜å‚¨
const hashedPassword = await bcrypt.hash(password, 10);

// ä¸è¿”å›æ•æ„Ÿå­—æ®µ
const user = await prisma.user.findUnique({
  where: { id },
  select: {
    id: true,
    nickname: true,
    avatar: true,
    // password: false  // ä¸è¿”å›å¯†ç 
  },
});
```

### è½¯åˆ é™¤

```typescript
// æ·»åŠ deletedAtå­—æ®µ
model User {
  // ...
  deletedAt DateTime?
}

// è½¯åˆ é™¤å®ç°
await prisma.user.update({
  where: { id },
  data: { deletedAt: new Date() }
})

// æŸ¥è¯¢æ—¶è¿‡æ»¤å·²åˆ é™¤æ•°æ®
await prisma.user.findMany({
  where: { deletedAt: null }
})
```

### è¡Œçº§æƒé™

```typescript
// ä¸­é—´ä»¶å®ç°è¡Œçº§æƒé™
prisma.$use(async (params, next) => {
  if (params.model === "Order") {
    // ç”¨æˆ·åªèƒ½æŸ¥çœ‹è‡ªå·±çš„è®¢å•
    if (params.action === "findMany") {
      params.args.where = {
        ...params.args.where,
        userId: currentUser.id,
      };
    }
  }
  return next(params);
});
```
