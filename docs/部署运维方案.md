# 部署运维方案

## 目录

1. [部署架构](#1-部署架构)
2. [环境配置](#2-环境配置)
3. [Vercel 部署](#3-vercel部署)
4. [数据库部署](#4-数据库部署)
5. [GitHub 配置](#5-github配置)
6. [CI/CD 流程](#6-cicd流程)
7. [监控与运维](#7-监控与运维)

---

## 1. 部署架构

### 1.1 整体架构

```
GitHub仓库
    ↓
Vercel (自动部署)
    ├── 前端应用 (frontend/)
    ├── 管理端 (admin/)
    └── 后端API (backend/)

外部服务
    ├── Vercel Postgres (数据库)
    ├── Vercel Blob (文件存储)
    └── Redis Cloud (缓存)
```

### 1.2 环境划分

| 环境         | 用途         | 域名示例                      |
| ------------ | ------------ | ----------------------------- |
| **开发环境** | 本地开发调试 | http://localhost:3000         |
| **预览环境** | PR 预览测试  | https://app-pr-123.vercel.app |
| **生产环境** | 正式线上服务 | https://your-app.vercel.app   |

---

## 2. 环境配置

### 2.1 环境变量

**后端环境变量** (`.env`):

```bash
# 应用配置
NODE_ENV=production
PORT=3000
APP_URL=https://your-app.vercel.app

# 数据库
DATABASE_URL=postgresql://user:pass@host:5432/dbname

# Redis
REDIS_URL=redis://user:pass@host:6379

# JWT密钥
JWT_SECRET=your-super-secret-key-change-this
JWT_EXPIRES_IN=2h
REFRESH_TOKEN_EXPIRES_IN=30d

# 文件上传
BLOB_READ_WRITE_TOKEN=vercel_blob_token

# 第三方服务
# 支付
WECHAT_APP_ID=your_wechat_app_id
WECHAT_APP_SECRET=your_wechat_app_secret
ALIPAY_APP_ID=your_alipay_app_id
ALIPAY_PRIVATE_KEY=your_alipay_private_key

# 短信
SMS_ACCESS_KEY=your_sms_access_key
SMS_SECRET_KEY=your_sms_secret_key

# OSS存储
OSS_ACCESS_KEY=your_oss_access_key
OSS_SECRET_KEY=your_oss_secret_key
OSS_BUCKET=your-bucket-name
OSS_REGION=oss-cn-beijing

# 监控
SENTRY_DSN=https://xxx@sentry.io/xxx
```

**前端环境变量** (`.env.production`):

```bash
VITE_API_URL=https://your-app.vercel.app/api
VITE_APP_NAME=零售电商App
VITE_SENTRY_DSN=https://xxx@sentry.io/xxx
```

### 2.2 配置文件管理

**不同环境的配置**:

```typescript
// config/index.ts
const config = {
  development: {
    apiUrl: "http://localhost:3000/api",
    wsUrl: "ws://localhost:3000",
  },
  production: {
    apiUrl: process.env.VITE_API_URL,
    wsUrl: process.env.VITE_WS_URL,
  },
};

export default config[process.env.NODE_ENV];
```

---

## 3. Vercel 部署

### 3.1 项目结构调整

**Monorepo 结构**:

```
project-root/
├── frontend/          # 用户端
│   ├── package.json
│   └── vercel.json
├── admin/            # 管理端
│   ├── package.json
│   └── vercel.json
├── backend/          # 后端API
│   ├── package.json
│   └── vercel.json
├── docs/             # 文档
├── package.json      # 根package.json
└── vercel.json       # 根配置
```

### 3.2 Vercel 配置文件

**前端 vercel.json**:

```json
{
  "buildCommand": "npm run build",
  "outputDirectory": "dist",
  "framework": "vite",
  "routes": [
    {
      "src": "/assets/(.*)",
      "headers": { "cache-control": "max-age=31536000,immutable" }
    },
    {
      "handle": "filesystem"
    },
    {
      "src": "/(.*)",
      "dest": "/index.html"
    }
  ]
}
```

**后端 vercel.json**:

```json
{
  "version": 2,
  "builds": [
    {
      "src": "src/app.ts",
      "use": "@vercel/node"
    }
  ],
  "routes": [
    {
      "src": "/(.*)",
      "dest": "src/app.ts"
    }
  ],
  "env": {
    "NODE_ENV": "production"
  }
}
```

### 3.3 部署步骤

**1. 安装 Vercel CLI**:

```bash
npm install -g vercel
```

**2. 登录 Vercel**:

```bash
vercel login
```

**3. 初始化项目**:

```bash
# 在项目根目录
vercel

# 按提示选择：
# - Set up and deploy? Yes
# - Which scope? Your team
# - Link to existing project? No
# - Project name? retail-ecommerce-app
```

**4. 配置环境变量**:

```bash
# 通过CLI添加
vercel env add DATABASE_URL production
vercel env add JWT_SECRET production

# 或在Vercel Dashboard中添加
# Settings > Environment Variables
```

**5. 部署**:

```bash
# 部署到生产环境
vercel --prod

# 部署预览环境
vercel
```

### 3.4 自动部署配置

**连接 GitHub 仓库**:

1. 在 Vercel Dashboard 中点击"Import Project"
2. 选择 GitHub 仓库
3. 配置构建设置
4. 添加环境变量
5. 点击 Deploy

**分支部署规则**:

- `main` 分支 → 自动部署到生产环境
- `dev` 分支 → 自动部署到预览环境
- PR → 自动创建预览部署

---

## 4. 数据库部署

### 4.1 Vercel Postgres

**创建数据库**:

```bash
# 在Vercel Dashboard中
# Storage > Create Database > Postgres
# 选择区域和计划
```

**连接配置**:

```bash
# Vercel会自动设置以下环境变量
POSTGRES_URL
POSTGRES_PRISMA_URL
POSTGRES_URL_NON_POOLING
```

**在项目中使用**:

```typescript
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}
```

### 4.2 数据库迁移

**本地迁移**:

```bash
# 生成迁移文件
npx prisma migrate dev --name init

# 应用迁移
npx prisma migrate deploy
```

**生产环境迁移**:

```bash
# 在vercel.json中配置
{
  "build": {
    "env": {
      "ENABLE_PRISMA_MIGRATE": "1"
    }
  }
}

# 或在package.json中添加
{
  "scripts": {
    "vercel-build": "prisma generate && prisma migrate deploy && npm run build"
  }
}
```

### 4.3 备份策略

**自动备份**:

- Vercel Postgres 提供每日自动备份
- 保留 30 天备份历史

**手动备份**:

```bash
# 导出数据
pg_dump $DATABASE_URL > backup_$(date +%Y%m%d).sql

# 导入数据
psql $DATABASE_URL < backup.sql
```

---

## 5. GitHub 配置

### 5.1 仓库结构

```
your-repo/
├── .github/
│   └── workflows/
│       ├── ci.yml          # CI流程
│       └── deploy.yml      # 部署流程
├── frontend/
├── admin/
├── backend/
├── docs/
├── .gitignore
├── README.md
└── package.json
```

### 5.2 .gitignore

```gitignore
# Dependencies
node_modules/
.pnp
.pnp.js

# Testing
coverage/

# Production
dist/
build/
.vercel

# Environment
.env
.env.local
.env.production.local
.env.*.local

# Logs
logs/
*.log
npm-debug.log*

# IDEs
.vscode/
.idea/
*.swp
*.swo

# OS
.DS_Store
Thumbs.db

# Prisma
prisma/migrations/**/migration.sql
```

### 5.3 分支管理策略

**分支模型**:

```
main (生产环境)
  └── dev (开发环境)
       ├── feature/user-auth
       ├── feature/product-list
       └── hotfix/cart-bug
```

**分支规范**:

- `main`: 生产分支，只接受来自`dev`的合并
- `dev`: 开发分支，功能开发的基础分支
- `feature/*`: 功能分支，开发新功能
- `hotfix/*`: 紧急修复分支
- `release/*`: 发布分支

### 5.4 提交规范

**Commit Message 格式**:

```
<type>(<scope>): <subject>

<body>

<footer>
```

**类型(type)**:

- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式调整
- `refactor`: 重构
- `perf`: 性能优化
- `test`: 测试
- `chore`: 构建/工具

**示例**:

```
feat(product): 添加商品搜索功能

- 实现商品全文搜索
- 添加搜索建议
- 优化搜索性能

Closes #123
```

---

## 6. CI/CD 流程

### 6.1 GitHub Actions 配置

**CI 工作流** (`.github/workflows/ci.yml`):

```yaml
name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]

jobs:
  lint-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run type check
        run: npm run type-check

      - name: Run tests
        run: npm run test

      - name: Build
        run: npm run build
```

**部署工作流** (`.github/workflows/deploy.yml`):

```yaml
name: Deploy to Vercel

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Deploy to Vercel
        uses: amondnet/vercel-action@v20
        with:
          vercel-token: ${{ secrets.VERCEL_TOKEN }}
          vercel-org-id: ${{ secrets.ORG_ID }}
          vercel-project-id: ${{ secrets.PROJECT_ID }}
          vercel-args: "--prod"
```

### 6.2 自动化测试

**单元测试**:

```typescript
// __tests__/user.service.test.ts
import { UserService } from "../src/services/user.service";

describe("UserService", () => {
  it("should create user successfully", async () => {
    const userData = {
      phone: "13800138000",
      password: "password123",
    };
    const user = await UserService.create(userData);
    expect(user).toBeDefined();
    expect(user.phone).toBe("13800138000");
  });
});
```

**集成测试**:

```typescript
// __tests__/api/auth.test.ts
import request from "supertest";
import app from "../src/app";

describe("Auth API", () => {
  it("POST /api/auth/login - success", async () => {
    const response = await request(app).post("/api/auth/login").send({
      phone: "13800138000",
      password: "password123",
    });

    expect(response.status).toBe(200);
    expect(response.body.data.accessToken).toBeDefined();
  });
});
```

---

## 7. 监控与运维

### 7.1 错误监控 - Sentry

**安装配置**:

```bash
npm install @sentry/node @sentry/vue
```

**后端配置**:

```typescript
// src/app.ts
import * as Sentry from "@sentry/node";

Sentry.init({
  dsn: process.env.SENTRY_DSN,
  environment: process.env.NODE_ENV,
  tracesSampleRate: 1.0,
});

// 错误处理中间件
app.use(Sentry.Handlers.errorHandler());
```

**前端配置**:

```typescript
// main.ts
import * as Sentry from "@sentry/vue";

Sentry.init({
  app,
  dsn: import.meta.env.VITE_SENTRY_DSN,
  integrations: [new Sentry.BrowserTracing(), new Sentry.Replay()],
  tracesSampleRate: 0.1,
  replaysSessionSampleRate: 0.1,
  replaysOnErrorSampleRate: 1.0,
});
```

### 7.2 性能监控

**关键指标**:

- API 响应时间
- 数据库查询时间
- 缓存命中率
- 错误率
- QPS (每秒查询数)

**监控工具**:

- Vercel Analytics (内置)
- Google Analytics
- 自定义监控 Dashboard

### 7.3 日志管理

**日志级别**:

```typescript
import winston from "winston";

const logger = winston.createLogger({
  level: process.env.LOG_LEVEL || "info",
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.json()
  ),
  transports: [
    new winston.transports.Console(),
    new winston.transports.File({
      filename: "error.log",
      level: "error",
    }),
    new winston.transports.File({
      filename: "combined.log",
    }),
  ],
});
```

**日志查看**:

```bash
# Vercel日志
vercel logs

# 实时日志
vercel logs --follow
```

### 7.4 健康检查

**健康检查端点**:

```typescript
// src/routes/health.ts
router.get("/health", async (req, res) => {
  try {
    // 检查数据库连接
    await prisma.$queryRaw`SELECT 1`;

    // 检查Redis连接
    await redis.ping();

    res.json({
      status: "healthy",
      timestamp: new Date(),
      uptime: process.uptime(),
      environment: process.env.NODE_ENV,
    });
  } catch (error) {
    res.status(503).json({
      status: "unhealthy",
      error: error.message,
    });
  }
});
```

### 7.5 告警配置

**Vercel 告警**:

- 部署失败通知
- 错误率超阈值
- 响应时间超标

**自定义告警**:

```typescript
// 错误率监控
if (errorRate > 5) {
  await sendAlert({
    type: "error_rate",
    message: `错误率超过5%: ${errorRate}%`,
    severity: "high",
  });
}

// 数据库连接监控
if (dbConnectionFailed) {
  await sendAlert({
    type: "database",
    message: "数据库连接失败",
    severity: "critical",
  });
}
```

---

## 8. 性能优化

### 8.1 CDN 配置

**Vercel Edge Network**:

- 自动 CDN 加速
- 全球节点分发
- 智能路由

**静态资源优化**:

```javascript
// vite.config.ts
export default defineConfig({
  build: {
    rollupOptions: {
      output: {
        manualChunks: {
          vendor: ["vue", "vue-router", "pinia"],
          ui: ["element-plus"],
        },
      },
    },
  },
});
```

### 8.2 缓存策略

**HTTP 缓存头**:

```typescript
// 静态资源
res.setHeader("Cache-Control", "public, max-age=31536000, immutable");

// API响应
res.setHeader("Cache-Control", "private, max-age=60");
```

**Redis 缓存**:

```typescript
const cacheKey = `product:${id}`;
const cached = await redis.get(cacheKey);

if (cached) {
  return JSON.parse(cached);
}

const product = await prisma.product.findUnique({ where: { id } });
await redis.setex(cacheKey, 300, JSON.stringify(product));
```

### 8.3 数据库优化

**连接池**:

```typescript
// prisma/schema.prisma
datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  // 连接池配置
  // ?connection_limit=10&pool_timeout=20
}
```

**查询优化**:

- 使用索引
- 避免 N+1 查询
- 使用分页
- 合理使用 JOIN

---

## 9. 安全加固

### 9.1 HTTPS 配置

Vercel 自动提供 SSL 证书,支持:

- 自动续期
- TLS 1.3
- HTTP/2

### 9.2 安全头配置

```typescript
// 安全中间件
app.use((req, res, next) => {
  res.setHeader("X-Content-Type-Options", "nosniff");
  res.setHeader("X-Frame-Options", "DENY");
  res.setHeader("X-XSS-Protection", "1; mode=block");
  res.setHeader("Strict-Transport-Security", "max-age=31536000");
  next();
});
```

### 9.3 环境变量安全

- 敏感信息存储在 Vercel 环境变量中
- 不同环境使用不同密钥
- 定期轮换密钥
- 使用 Vercel Secrets 加密敏感信息

---

## 10. 灾难恢复

### 10.1 备份策略

**数据库备份**:

- 每日自动备份
- 保留 30 天
- 异地存储

**代码备份**:

- GitHub 仓库
- 多人权限管理
- 分支保护

### 10.2 回滚方案

**Vercel 回滚**:

```bash
# 回滚到上一个部署
vercel rollback

# 回滚到指定部署
vercel rollback [deployment-url]
```

**数据库回滚**:

```bash
# 使用Prisma迁移回滚
npx prisma migrate reset

# 恢复备份
psql $DATABASE_URL < backup.sql
```

---

## 11. 成本优化

### 11.1 Vercel 定价

**免费套餐**:

- 100 GB 带宽/月
- 无限制部署
- 自动 SSL

**Pro 套餐** ($20/月):

- 1 TB 带宽/月
- 高级分析
- 团队协作

### 11.2 资源优化

**减少构建时间**:

- 使用缓存
- 增量构建
- 并行构建

**减少带宽消耗**:

- 图片压缩
- Gzip 压缩
- Tree shaking

---

## 12. 部署检查清单

**部署前检查**:

- [ ] 环境变量配置完成
- [ ] 数据库迁移测试通过
- [ ] 所有测试通过
- [ ] 代码已 review
- [ ] 版本号已更新
- [ ] 变更日志已更新

**部署后检查**:

- [ ] 健康检查通过
- [ ] 关键功能测试
- [ ] 性能监控正常
- [ ] 错误率在正常范围
- [ ] 日志无异常
- [ ] 数据完整性检查

---

**部署完成后，您的应用将在以下地址访问**:

- 用户端: https://your-app.vercel.app
- 管理端: https://your-app-admin.vercel.app
- API 文档: https://your-app.vercel.app/api/docs
